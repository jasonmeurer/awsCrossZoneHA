{
"AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Cloudformation Template to add API Gateway, Lambda and Palo Alto Networks NGFW components to support Cross Zone HA",
    "Metadata": {

    },
    "Parameters": {
        "S3Bucket": {
            "Description": "S3 Bucket containing Lambda service code",
            "Type": "String"
        },
        "S3Key": {
            "Description": "S3 Zip file containg Lambda service code",
            "Type": "String",
            "Default": "crosszoneha.zip"
        },
        "LambdaSubnetIDs" : {
            "Description" : "Choose 2 Lambda Subnet IDs",
            "Type" : "List<AWS::EC2::Subnet::Id>"
        },
        "LambdaSecurityID" : {
            "Description" : "Choose the lambda security group",
            "Type" : "List<AWS::EC2::SecurityGroup::Id>"
        }
    },
    "Mappings": {

    },
    "Conditions": {

    },
    "Resources": {    
        "CrossZoneRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [ {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "lambda.amazonaws.com"
                        },
                    "Action": "sts:AssumeRole"
                    } ]
                },
                "Path":"/",
                "RoleName": {"Fn::Join": ["-", ["CrossZoneHARole", { "Ref": "AWS::StackName" }]]},
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                  ],
                "Policies": [ {
                    "PolicyName" : {"Fn::Join": ["-", ["CrossZoneHAPol", { "Ref": "AWS::StackName" }]]},
                    "PolicyDocument": {
                        "Version" : "2012-10-17",
                        "Statement": [
                            {
                            "Effect": "Allow",
                            "Action": [
                                "ec2:CreateRoute",
                                "ec2:DeleteRoute",
                                "logs:*",
                                "ec2:DescribeRouteTables",
                                "ec2:ReplaceRoute",
                                "ec2:AssociateRouteTable",
                                "ec2:DescribeSecurityGroups",
                                "ec2:DescribeSubnets",
                                "ec2:DescribeVpcs"
                            ],
                            "Resource": [
                            "*"
                            ]
                        }]
                    }
                }]
            }
        },
        "CrossZoneLambda": {
            "Type": "AWS::Lambda::Function",
            "DependsOn" : "CrossZoneRole",
            "Properties": {
                "FunctionName": {"Fn::Join": ["-", ["CrossZoneHALambda", { "Ref": "AWS::StackName" }]]},
                "Code": {
                    "S3Bucket": {"Ref": "S3Bucket"},
                    "S3Key": {"Ref": "S3Key"}
                },
                "Description": "CrossZoneHA for Palo Alto Networks virtual firewalls",
                "Handler": "crosszonehawithpathcheck.lambda_handler",
                "Role": {"Fn::GetAtt": ["CrossZoneRole", "Arn"]},
                "Runtime": "python3.8",
                "Timeout": 30,
                "VpcConfig": {
                    "SecurityGroupIds" :  {"Ref":"LambdaSecurityID"} ,
                    "SubnetIds" :  {"Ref":"LambdaSubnetIDs"} 
                }
            }
        }
    },
    "Outputs": {

    }
}